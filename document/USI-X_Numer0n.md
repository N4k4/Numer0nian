# USI-X_Numer0n

## これは何
Numer0nian向けに制定された、ヌメロン対戦エンジンとNumer0nianとのやり取りを行うための通信プロトコルです。

[USI](http://shogidokoro.starfree.jp/usi.html)及び[USI-X](https://yaneuraou.yaneu.com/2022/06/07/standard-communication-protocol-for-games/)をベースとしています。

USI-Xを名乗ってはいますが、USIで実装されているコマンドのすべてを実装しているわけではなく、正式な拡張ではない点にご注意ください。
そのため、USI-X対応対局スクリプトでの動作を保証しません。

## OXプロトコル全般の注意
- サーバーとエンジン間の通信のやり取りは、標準入出力を通してテキストコマンドで行われます。
- エンジンは思考中であってもコマンドの受信をする必要があります。
- コマンドの送受信は半角英数字を使用します
    - 全角文字は基本的にその一切をサポートしないものとします。
- エンジンがコマンドを送信する際、末尾には必ず改行コード(\n)を追加する必要があります。サーバー側では改行をもってコードを認識します。


## 盤面と指し手の表現について
盤面と指し手の表現はUSI-XにおいてはSFEN(Standard Forsyth-Edwards Notation)表現を用いて行うとされています。
USI-X_Numer0nにおいては以下のように設定します。なお、他のゲームとの互換性は存在しないので注意してください。

### 初期盤面
ヌメロンにおいての初期盤面は基本的に`startpos`によってあらわされます。
アイテムを有効化する場合のみ`sfen`コマンドによる任意盤面表示を採用します。なお、現在(2022/07/09時点)はNUmer0nianにおいてアイテム機能の実装予定はありません。

アイテムの種類はそれぞれ1文字のアルファベットで表され、先手のアイテムは大文字、後手のアイテムは小文字になります。

**ここに実装するアイテムの一覧が入ります**

### 指し手
指し手は基本的に宣言する数字そのものになります。例)`012`

アイテムを利用する場合は`<アイテム名>:<アイテム利用オプション>`
の形式で宣言します。

### 返り値
宣言した数字に対する結果は`position`コマンドによって返されます。

`<Eat>-<Byte>`あるいは`<アイテムの結果>`のいずれかの形式で送られます。

自分が宣言した直後に結果を得たい場合は、`bestmove`コマンド発行時に`ponder`オプションをつける必要があります。

## GUIからエンジンに送られるコマンド

### usi
 ```
 usi
 ```
 GUIがエンジンを起動したときに最初に送るコマンドです。
 エンジンはこのコマンドを受信したらすぐにidコマンドを返し、必要に応じてoptionコマンドを返します。そして最後にusiokコマンドを返す必要があります。

### isready
 ```
 isready
 ```
 対局開始前に送ります。エンジンは対局準備ができたらreadyokコマンドを返します。

### setoption
```
setoption <id> [value <x>]
```

エンジンに対して値を設定する時に送ります。
`<id>`で指定する名前は、エンジンが起動時にoptionコマンドで返した名前になります。`value <x>`で指定する部分は、文字列であればその文字列を入れ、チェックボックスのブーリアン値であればtrueまたはfalseになります。

### usinewgame
 ```
 usinewgame
 ```

 対局開始時に送ります。これで対局開始になります。

### position
```
position [sfen <sfenstring> | startpos ] [ moves <move1> <result1> ... <movei> <resulti>]
```

思考開始局面をエンジンに知らせるためのコマンドです。エンジンに思考を開始させる場合、`position`コマンドで思考開始局面を送り、それに続けて`go`コマンドを送って思考開始を命令することになります。

初期局面については、アイテム利用がない場合は`startpos`と書き、それ以外の場合ではsfenに続けてアイテムの設定を記述します。

それに続くmovesの部分は動作とそれに伴う結果が繰り返されています。数字を宣言した場合とアイテムを使用した場合で記法に差があります

#### 数字を宣言する場合
```
moves <宣言した数字> <Eat>-<Byte>
```

例えば、「012」と宣言した結果が「0Eat 2Byte」だった場合
```
moves 012 0-2
```
となります。

#### アイテムを使用する場合
```
moves <使用アイテム名> <アイテム利用結果>
```

アイテムの利用については、実装未定のため、記法のみ設定して詳細の実装や定義は未定とします。

### go
```
go <options> 
```
思考開始の合図です。エンジンはこれを受信すると思考を開始します。
自分の手番の時に思考を開始することを通常思考と呼びます。相手の手番の時に思考を開始することを先読み思考と呼びます。後述しますが、go ponderによって思考を開始するときは先読み思考、ponderがついていないgoコマンドで思考を開始するときは通常思考となります。
以下に、goコマンドのオプションについて解説します。

#### ponder
```
go ponder
```
このコマンドが用いられる場合は上記のようにgoの直後に着けられます。
このオプションがつけられた時、エンジンは先読み思考を行います。

このコマンドで思考開始する場合、GUIから次のコマンド(stopやponderhit)が送られてくる前にbestmoveで指し手を返してはいけません。
相手が行動するとそれによって`stop`または`ponderhit`が送られてくるので、それを待ってからbestmoveで指し手を返すことになります。

#### btime,wtime
```
btime <x>
wtime <x>
```
先手と後手の残り時間を表示します。(btimeは先手の残り時間、wtimeは後手の残り時間)
単位はミリ秒です。

USIでは残り時間に関するオプションが複数ありましたが、ここではこの項目のみ定義しほかの項目は未実装とします。







## エンジンからGUIに送られるコマンド
